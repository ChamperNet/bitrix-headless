## Концепция

Модуль в Bitrix Headless CMS - основной "кирпичик", на котором строится функционал решения. Модуль включает в себя две базовых составляющих - логику на PHP для Backend и шаблон на Vue для представления на Frontend. При установке модуля в папке /backend/bitrix/modules/{name} происходит разархивация и создание файловой структуры. Одновременно с этим в папку /frontend/components/{name} добавляются Vue компоненты.

Модуль может поставляться без шаблонов для Frontend, но не может не содержать логики для Backend.

Структура модуля

- {name}
	- install
		- index.php
		- version.php
	- lib
		- console
		- events
		- exceptions
		- http
			- controllers
				- {controller_name}.php
			- middlewares
		- listeners
	- templates
		- vue
	- .settings

## Основные модули

  
- ### Модуль **"Местоположение"**
	- **Предназначение**
		- Используется для определения, вывода и взаимодействия с гео-локацией пользователя.
		- Выбранное местоположение влияет на:
			- Список доступных способов доставки
			- Список доступных способов оплаты
			- Список адресов самовывоза
			- Список складов
			- Список магазинов (инфо-блок "Магазины")
			- другие зависимости, указываемые разработчиком
	- **Используемые endpoints и методы (backend)**
		- /rest/{UserId}/{token}/locations - endpoint
		- locations.getById(id) - возвращает информацию о конкретном местоположении по id
		- locations.getAll(params) - возвращает список доступных местоположений с учетом указанных параметров
		- locations.setLocationForUser(params) - записывает для пользователя выбранное местоположение
	- **Имеющиеся методы (frontend)**
		- Модуль имеет следующие методы получения списка местоположений
			- getGeolocation()
			- getPlaces()
			- getPlaceData(id)
			- showPlacesModal()
	- **Описание функционала и принцип работы**
		- Используется для определения геолокации пользователя с помощью GeoIp\Manager ::getRealIp() и \Bitrix\Sale\Location\GeoIp ::getLocationId.
		- Ключ "chosen_city" в localStorage имеет значение в виде массива, где два значения - код местоположения и название местоположения.
		- Рассмотрим два сценария:
			- Визит авторизованного пользователя
				- Получаем данные из профиля пользователя и записываем их в localStorage через ключ "chosen_city"
				- Если по какой-то причине данных нет в БД, то следуем по сценарию визита неавторизованного пользователя
			- Визит неавторизованного пользователя
				- При первом визите неавторизованного пользователя происходит проверка наличия ключа и значения в localStorage "chosen_city". 
				- В случае наличия ключа "chosen_city" - данные оттуда подтягиваются в модуль. 
				- В противном случае - пользователь видит всплывающее окно с текстом: "Ваш город - {Город}?" и кнопками "Да" и "Нет, выбрать другой", где {Город} - автоматически определившийся по IP пользователя город из списка местоположений в Битрикс.
				- Нажатие на кнопку "Да" закрывает модальное окно.
				- Нажатие на кнопку "Нет, выбрать другой" приводит к вызову модального окна для выбора местоположения.
				- Модальное окно для выбора местоположения имеет список из 10 наиболее популярных местоположений в виде ссылок и поисковую строку. 
				- Клик по любому местоположению из списка популярных приводит к записи данных выбранного местоположения в localStorage в ключ "chosen_city" и также приводит к перезагрузке странице и отправки новых запросов, учитывающих выбранное местоположение.
				- Поисковая строка реагирует на ввод первых три букв и ищет совпадения в таблице местоположений по названию. Результаты поиска без перезагрузки показываются пользователю в виде ссылок с названиями соответствующих (целиком или частично) поисковой фразе местоположений.
	
- ### Модуль **"Избранные товары"** 
	- **Предназначение**
		- Используется для хранения, изменения и отображения листинга товаров, добавленных в избранное любым пользователем (авторизованным или нет)
	- **Используемые endpoints и методы (backend)**
		- /rest/{UserId}/{token}/favorites - endpoint
		- favorites.getProducts(user_id) - возвращает список с минимальными необходимыми данными всех товаров, добавленных в избранное пользователем, проверяя права на просмотр для текущего пользователя.
		- favorites.getProductsFullData(user_id) - работает также как и предыдущий метод, только возвращает больший объем данных.
		- favorites.addProduct(product_id) - добавляет товар с product_id в избранное
		- favorites.removeProduct(product_id) - удаляет товар из избранного
		- favorites.clear(user_id) - очищает все записи об избранном для пользователя
		- favorites.cleanGarbage(user_id) - проверяет в БД записи об избранном для неавторизованных пользователей и удаляет те, которые старше 30/60/90 дней.
	- **Имеющиеся методы (frontend)**
		- getFavorites() - используется для отображения данных в шапке сайта в минималистичном виде
		- getFavoritesFullData() - используется для отображения детальной информации о товарах (включая хар-ки) на странице "Мои избранное"
		- addFavorite(ProductId)
		- removeFavorite(ProductId)
		- clearFavorites()
	- **Описание функционала и принцип работы**
		- В localStorage по ключу "favorite_products" хранятся только ID товаров в виде одномерного массива.
		- В HL "Избранное" хранятся все добавленные пользователем товары (id, дата добавления, id пользователя)
		- Рассмотрим два сценария:
			- Визит неавторизованного пользователя
				- При первом визите неавторизованного пользователя происходит проверка наличия ключа и значения в localStorage "favorite_products". 
				- В случае наличия ключа "favorite_products" - данные по этому ключу  подтягиваются в модуль. 
			- Визит авторизованного пользователя
				- Получаем данные из HL-блока favorites для конкретного пользователя и записываем их в localStorage через ключ "favorite_products"
				- Если по какой-то причине данных нет в БД, то создаем для пользователя запись в в таблице с пустым массивом и создаем в localStorage ключ "favorite_products" с пустым массивом
			 - Общий функционал
				- При взаимодействии с карточкой товара или детальной страницей товара пользователь добавляет товар в избранное.
				- При добавлении товара в "Избранное" в счетчике модуля на frontend происходит инкрементирование значения кол-ва товаров, добавленных в "Избранное"
				- Модуль выполняет запрос на получения минимальных данных по товарам, используя их id.
				- Создается или обновляется запись в HL с id пользователя и массивом выбранных им товаров, а также датой добавления каждого товара.
				- При наведении курсора на модуль "Избранное" на frontend происходит отображение скрытого по умолчанию окна со списком товаров, добавленных пользователем в "Избранное"
				- При переходе на отдельную страницу "Мои избранное" пользователю доступны два компонента: сортировка по категориям и листинг товаров с дизайном как в каталоге.
				- На детальной странице имеется кнопка "Очистить список"

- ### Модуль **"Сравнение товаров"** 
	- **Предназначение**
		- Используется для хранения, изменения и отображения листинга товаров, добавленных в сравнение любым пользователем (авторизованным или нет)
	- **Используемые endpoints и методы (backend)**
		- /rest/{UserId}/{token}/comparison - endpoint
		- comparison.getProducts(user_id) - возвращает список с минимальными необходимыми данными всех товаров, добавленных в сравнение пользователем, проверяя права на просмотр для текущего пользователя.
		- comparison.getProductsFullData(user_id) - работает также как и предыдущий метод, только возвращает больший объем данных.
		- comparison.addProduct(product_id) - добавляет товар с product_id в сравнение
		- comparison.removeProduct(product_id) - удаляет товар из сравнения
		- comparison.clear(user_id) - очищает все записи о товарах для сравнения для пользователя
		- comparison.cleanGarbage(user_id) - проверяет в БД записи о товарах для сравнения для неавторизованных пользователей и удаляет те, которые старше 30/60/90 дней.
	- **Имеющиеся методы (frontend)**
		- getComparison() - используется для отображения данных в шапке сайта в минималистичном виде
		- getComparisonFullData() - используется для отображения детальной информации о товарах (включая хар-ки) на странице "Товары для сравнения"
		- addComparison(ProductId)
		- removeComparison(ProductId)
		- clearComparison()
	- **Описание функционала и принцип работы**
		- В localStorage по ключу "comparison_products" хранятся только ID товаров в виде одномерного массива.
		- В HL "Сравнение" хранятся все добавленные пользователем товары (id, дата добавления, id пользователя)
		- Рассмотрим два сценария:
			- Визит неавторизованного пользователя
				- При первом визите неавторизованного пользователя происходит проверка наличия ключа и значения в localStorage "comparison_products". 
				- В случае наличия ключа "comparison_products" - данные по этому ключу  подтягиваются в модуль. 
			- Визит авторизованного пользователя
				- Получаем данные из HL-блока "Сравнение" для конкретного пользователя и записываем их в localStorage через ключ "comparison_products"
				- Если по какой-то причине данных нет в БД, то создаем для пользователя запись в в таблице с пустым массивом и создаем в localStorage ключ "comparison_products" с пустым массивом
			 - Общий функционал
				- При взаимодействии с карточкой товара или детальной страницей товара пользователь добавляет товар для сравнения.
				- При добавлении товара в "Товары для сравнения" в счетчике модуля на frontend происходит инкрементирование значения кол-ва товаров.
				- Модуль выполняет запрос на получения минимальных данных по товарам, используя их id.
				- Создается или обновляется запись в HL с id пользователя и массивом выбранных им товаров, а также датой добавления каждого товара.
				- При наведении курсора на модуль "Товары для сравнения" на frontend происходит отображение скрытого по умолчанию окна со списком товаров, добавленных пользователем в "Товары для сравнения"
				- При переходе на отдельную страницу "Товары для сравнения" пользователю доступны два компонента: сортировка по категориям и листинг товаров, в котором каждая карточка товара содержит таблицу с характеристиками для сравнения
				- На детальной странице имеется кнопка "Очистить список"

- ### Модуль "Личный кабинет"
	- **Предназначение**
		- Используется для отображения персональных данных авторизованного пользователя и доступа к функциям личного кабинета с учетом группы, а также для авторизации или регистрации неавторизованного пользователя.
	- **Используемые endpoints и методы (backend)**
		- /rest/{UserId}/{token}/personal - endpoint
		- personal.auth(params) - авторизация пользователя
		- personal.resetPassword(email) - сброс пароля для пользователя по e-mail
		- personal.exit() - выход для авторизованного пользователя
		- personal.getUserData() - получение минимальных данных о пользователе
		- personal.getUserFullData() - получение подробных данных из анкеты пользователя
		- personal.deleteUser() - удаление пользователя по его желанию из БД (или теневое удаление)
		- personal.register(params) - регистрация нового пользователя
		- personal.getCode() - генерация и возвращение уникального значения "Код пользователя", необходимого для обращения, например, в тех. поддержку.
	- **Имеющиеся методы (frontend)**
	- **Описание функционала и принцип работы**

- ### Модуль "Корзина"
	- **Предназначение**
		- Используется для хранения, изменения и отображения листинга товаров, добавленных в корзину любым пользователем (авторизованным или нет)
	- **Используемые endpoints и методы (backend)**
		- /rest/{UserId}/{token}/cart - endpoint
		- cart.getProducts(user_id) - возвращает список с минимальными необходимыми данными всех товаров, добавленных в корзину пользователем, проверяя права на просмотр для текущего пользователя.
		- cart.getProductsFullData(user_id) - работает также как и предыдущий метод, только возвращает больший объем данных.
		- cart.addProduct(product_id, quantity) - добавляет товар с product_id в корзину в кол-ве {quantity} штук
		- cart.changeQuantity(product_id, quantity) - изменяет кол-во товара в корзине и изменяет дату добавления или изменения товара в корзине на текущую
		- cart.removeProduct(product_id) - удаляет товар из сравнения
		- cart.clear(user_id) - очищает все записи о товарах в корзине для пользователя
		- cart.cleanGarbage(user_id) - проверяет в БД записи о товарах в корзине для неавторизованных пользователей и удаляет те, которые старше 30/60/90 дней.
	- **Имеющиеся методы (frontend)**
		- getCart()
		- getCartFullData()
		- addCartProduct(productId, quantity)
		- changeQuantity(productId, quantity)
		- removeCartProduct(productId)
		- clearCart()
	- **Описание функционала и принцип работы**
		- В localStorage по ключу "cartUuid" хранится только строка с UUID от id записи в БД с данными корзины по конкретному пользователю.
		- Используем стандартную таблицу для хранения корзин пользователей, чтобы избежать в будущем проблем с совместимостью с другими решениями.
		- Рассмотрим два сценария:
			- Визит неавторизованного пользователя
				- Создаем запись стандартными средствами Битрикс
				- Корзина хранится 30 дней по умолчанию (можно изменить в настройках коробочного модуля "Интернет-магазин" (sale))
				- Записываем в localStorage по ключу "cartUuid" значение id записи в БД с данными пользовательском корзины
			- Визит авторизованного пользователя
				- Стандартным методом Битрикса получаем корзину по id пользователя


{{ Контент добавляется... }}
