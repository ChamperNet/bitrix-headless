#ssl_certificate      /etc/nginx/letsencrypt/live/q-flex.ru/fullchain.pem;
#ssl_certificate_key  /etc/nginx/letsencrypt/live/q-flex.ru/privkey.pem;
#ssl_trusted_certificate /etc/nginx/letsencrypt/live/q-flex.ru/chain.pem;

## block the bad actors
set $block 0;

if ($bad_agent) {
    set $block 1;
}

if ($bad_ip) {
    set $block 1;
}

# don't block bots users from using sitemap
if ($request_uri ~ ^/sitemap/$) {
    set $block 0;
}

if ($block) {
    return 302 https://$host/sitemap/;
}
## end of block

include security_headers.conf;

charset utf-8;
index index.php;

# remove multiple slashes
# duplicated slashes will work and won't be rewritten, fixing it in this configuration is tricky
rewrite ^([^.]*?\/)\/+(.*)$ $1$2 permanent;

location / {
    try_files $uri $uri/ /bitrix/urlrewrite.php$is_args$args;
}

location = /restore.php {
    fastcgi_pass php-upstream;
    include fastcgi.conf;

    client_body_buffer_size 8192m;
    client_max_body_size 8192m;
}

location = /favicon.png {
    log_not_found off;
    access_log off;
}

location ^~ /robots.txt {
    log_not_found off;
    access_log off;
    # aspro.max multi-region robots.txt rewrite
    rewrite "robots.txt" /aspro_regions/robots/robots_$host.txt break;
}

location = /404.html {
    internal;
    access_log off;
    return 404;
}

location ~ (/\.ht|/\.git|/\.gitignore|\.settings\.php|/composer|/bitrix/backup|/bitrix/updates|/bitrix/modules|/bitrix/php_interface|/bitrix/stack_cache|/bitrix/managed_cache|/bitrix/html_pages/\.|/upload/1c_exchange|local/modules|local/php_interface|/logs/|acrit.exportproplus) {
    deny all;
}

# Internal location
location ^~ /upload/support/not_image { internal; }

# aspro.max multi-region sitemap rewrite
location ~ ^/sitemap.*\.xml$ {
    rewrite "/(sitemap.*)\.xml" /aspro_regions/sitemap/$1_$host.xml break;
}

location ~* ^.+\.(xml|txt|jpeg|jpg|png|gif|bmp|ico|svg|tif|tiff|css|map|js|json|htm|ttf|otf|webp|woff2?|csv|rtf|doc|docx|xls|xlsx|ppt|pptx|odf|odp|ods|odt|pdf|psd|ai|eot|eps|ps|zip|tar|tgz|gz|rar|bz2?|7z|aac|m4a|mp3|mp4|ogg|wav|wma|3gp|avi|flv|m4v|mkv|mov|mpe?g|wmv|exe|iso|dmg|swf|webmanifest)$ {
    error_page 404 /404.html;
    log_not_found off;
    access_log off;
    expires max;
    add_header Cache-Control public;
    include security_headers.conf;
    valid_referers none blocked q-flex.ru *.q-flex.ru *.cdn-q-flex.ru;
    if ($invalid_referer) {
        return 403;
    }
}

# Disable access for non-static assets in cache location
location ~* ^/bitrix/cache { deny all; }

location ~ /upload/ {
    client_body_buffer_size 1024m;
    client_max_body_size 1024m;
}

location ~* ^/bitrix/admin/(sale_order|sale_delivery|sale_app_rest_sender|sprod_integr_).*\.php$ {
    fastcgi_pass php-upstream;
    include fastcgi.conf;
    add_header Content-Security-Policy "frame-ancestors 'self' https://qflex.bitrix24.ru;";
    add_header Access-Control-Allow-Origin "https://qflex.bitrix24.ru;";
}

location ~ \.php$ {
    try_files $uri $uri/ /bitrix/urlrewrite.php$is_args$args;
    # redirect index.php to page without it
    if ($request_uri ~* "^(.*/)index\.php$") {
        return 301 $1;
    }

    fastcgi_pass php-upstream;
    include fastcgi.conf;
}
